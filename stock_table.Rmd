---
title: "Stock Table"
author: "Robert Woody"
date: "10/23/2020"
output: 
  html_document:
    css: stock.css
---

```{r setup, include=FALSE}
library(reactable)
library(readr)
library(dplyr)
library(tidyr)
library(shiny)
library(crosstalk)
library(ggplot2)
library(lubridate)
library(sparkline)
library(stringr)
library(purrr)
source("utils.R")
#http://jsdatav.is/chap03.html
knitr::opts_chunk$set(echo = TRUE)
```

## Stock Data

```{r cars}
stocks <- read_csv("./data/stocks.csv") 

min_date <- max(stocks$date) %m+% years(-6)

stocks <- 
  stocks %>% subset(date >= min_date) %>%
  mutate_if(is.numeric, ~round(.x,2))

preview <- 
  stocks %>% 
  group_by(ticker) %>% 
  arrange(desc(date)) %>% group_modify(~head(.x,80))

reactable(preview %>% mutate_if(is.numeric, ~round(.x,5)))
```

```{r}
# Verify the data is pretty clean
min(stocks$date)
stocks %>% 
  subset(date >= "2013-08-24") %>% 
  group_by(ticker) %>% 
  summarise(dates = length(unique(date)),
            first = min(date)) %>%
  arrange(dates)
# Pay Pal is the exception, has less days.# 793
```

```{r}
selected_stocks <- read_csv("./data/top_50.csv") %>% mutate(Symbol = str_trim(Symbol))
stock_names <- selected_stocks$Name
names(stock_names) <- selected_stocks$Symbol
```



```{r}

lag_levels <- c("1 Week","1 Month","3 Months","6 Months","1 Year","2 Years","5 Years")
framework <- 
  stocks %>% 
  ungroup() %>%
  mutate(lag = factor(rep("1 Month", nrow(.)), levels = lag_levels))%>%
  expand(ticker,lag) 

```


```{r}

max_date <- as.Date("2018-08-24")
xf <- framework %>% 
  left_join(preview, by = "ticker") %>% 
  group_by(lag) %>%
  do(convert_lag(.,max_date)) %>%
  subset(date >= start_date & date <= max_date) %>%
  arrange(ticker,lag,date) %>%
  ungroup() %>%
  group_by(ticker,lag) %>%
  summarise(close_values = list(list("close" = close, "date"= date)))%>% 
  ungroup()

xf$close_values2 <- xf$close_values
xf$change <-
sapply(xf$close_values, function(x){
  round((pluck(x,"close") %>% tail(1) - pluck(x,"close")[1]) / pluck(x,"close")[1],4)
})
```




```{r}

stock_theme <- reactableTheme(backgroundColor = "black",
                              color = "white"
                              #style = 'font-family: "Work Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;"'
)



sdf <- SharedData$new(xf)
div(style = 'font-family: "Work Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;',
    filter_select("ticker", "Ticker", sdf, ~ticker),
    filter_select("lag", "Time Period", sdf, ~lag,multiple = FALSE),
    reactable(sdf,
              theme = stock_theme,
              columns = list(
                ticker = colDef(
                  name = "Company",
                  width = 200,
                  cell = function(value){
                    list(p(value,style = "font-weight: bold;"),
                         p(purrr::pluck(stock_names,value),style = "color:#a8a8a8;")
                    )
                  }
                ),
                close_values = colDef(
                  name = "Closing Value",
                  cell = function(values) {
                    build_sparkline(values)
                  }
                ),
                close_values2 = colDef(
                  name = "Closing Value",
                  cell = function(values) {
                    build_sparkline_2(values)
                  }
                ),
                
                lag = colDef(show = FALSE),
                change = colDef(name = "Change",
                                align = "center",
                                style = "padding-top:25px",
                                cell = function(value){
                                  100 * value
                                }
                                )

          
                #close_values = colDef(show = FALSE),
                #close_dates = colDef(show = FALSE)
              ))
)



```


```{r,eval=FALSE}
sl1 <- sparkline(
  c(5,4,5,-2,0,3),
  type='bar',
  barColor="#aaf",
  chartRangeMin=-5,
  chartRangeMax=10,
  # set an id that will make it easier to refer
  #  in the next sparkline
  elementId="sparkline-for-composite"
)

sl2 <- sparkline(
  c(4,1,5,7,9,9,8,7,6,6,4,7,8,4,3,2,2,5,6,7),
  type="line",
  fillColor = FALSE,
  lineColor ='red',
  chartRangeMin = -5,
  chartRangeMax = 10
)


# add sparkline as a composite
spk_composite(sl1, sl2)

# add values and options as a composite
spk_composite(
  sl1,
  values=c(4,1,5,7,9,9,8,7,6,6,4,7,8,4,3,2,2,5,6,7),
  options = list(
    type="line",
    fillColor = FALSE,
    lineColor ='red',
    chartRangeMin = -5,
    chartRangeMax = 10
  )
)


```
```{r,eval = FALSE}
jdata <- list(list(
    "date"="2018-01-01",
    
    "close" = 1),
    list(
    "date"="2018-01-02",
    
    "close" = 2))

spk_tool <- function(labels) {
  htmlwidgets::JS(
    sprintf(
"function(sparkline, options, field){
  return %s[field[0].offset];
}",
    jsonlite::toJSON(labels)
    )
  )
}

sv <- sparkline(
  preview %>% select(close,open),
  #pluck(xf$close_values, 1,"close"),
  type="line",
  tooltipFormat =  '{{close}}: ${{y}}',
  lineWidth = 2,
  fillColor = FALSE,
  lineColor ='red'
)


jsonlite::toJSON(c(1,3,5,3,8), seq.Date(as.Date("2015-01-01"),by="month",length.out =5) %>% as.character())

library(xts)
ap <- as.xts(AirPassengers)
 t(mapply(
      function(x,y){c(as.numeric(as.Date(x)),y)},
      index(ap),
      as.vector(ap[,1])
    ))
matrix(preview$date,preview$close,preview)

sparkline(
  c(1,3,5,3,8),
  type="line", 
  tooltipFormatter = htmlwidgets::JS(
    sprintf(
      "function(sp, options, fld){
  debugger;
  return %s[fld.x] + '<br/>';
}",
      jsonlite::toJSON(
        #paste(c(1,3,5,3,8),
        format(
          paste(preview$close,preview$date, sep = "<br>")[1:5]
        )
      )
    )
  )
)

seq.Date(as.Date("2015-01-01"),by="month",length.out =5)
paste(preview$close,preview$date, sep = "<br>")[1:4]

sv
```




```{r,eval = FALSE}
library(formattable)
  
  mtcars %>%
    group_by(cyl) %>%
    summarise(
      hp = spk_chr(
        hp, type="box",
        chartRangeMin=0, chartRangeMax=max(mtcars$hp)
      ),
      mpg = spk_chr(
        mpg, type="box",
        chartRangeMin=0, chartRangeMax=max(mtcars$mpg)
      )
    )
  
  
  
spk_tool <- function(labels) {
  htmlwidgets::JS(
    sprintf(
"function(sparkline, options, field){
  return %s[field[0].offset];
}",
    jsonlite::toJSON(labels)
    )
  )
}
spark_data1<-tribble(
  ~id,  ~spark,
#### use sparkline::spk_chr helper
####   note spk_chr build for easy usage with dplyr, summarize
  "a", spk_chr(1:3,type="bar", tooltipFormatter=spk_tool(c("C","D","E"))),
  "b", spk_chr(3:1,type="bar",tooltipFormatter=spk_tool(c("C","D","E")))
)

HTML(spk_chr(1:3,type="line", tooltipFormatter=spk_tool(c("C","D","E"))))
```





