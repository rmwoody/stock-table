---
title: "Stock Table"
author: "Robert Woody"
date: "10/23/2020"
output: 
  html_document:
    css: stock.css
---

```{r setup, include=FALSE}
library(reactable)
library(readr)
library(dplyr)
library(tidyr)
library(shiny)
library(crosstalk)
library(ggplot2)
library(lubridate)
library(sparkline)
library(stringr)
library(purrr)
source("utils.R")
#http://jsdatav.is/chap03.html
include_code <- FALSE
explain <- FALSE
knitr::opts_chunk$set(echo = include_code, message = FALSE, warning = FALSE)
```

## Stock Data

```{r, include = explain}
stocks <- read_csv("./data/stocks.csv") 
min_date <- max(stocks$date) %m+% years(-6)

stocks <- 
  stocks %>% subset(date >= min_date) %>%
  mutate_if(is.numeric, ~round(.x,2))

preview <- 
  stocks %>% 
  group_by(ticker) %>% 
  arrange(desc(date)) %>% group_modify(~head(.x,80))

reactable(preview %>% mutate_if(is.numeric, ~round(.x,5)))
```

```{r,include = explain}
# Verify the data is pretty clean
min(stocks$date)
stocks %>% 
  subset(date >= "2013-08-24") %>% 
  group_by(ticker) %>% 
  summarise(dates = length(unique(date)),
            first = min(date)) %>%
  arrange(dates)
# Pay Pal is the exception, has less days.# 793
```

```{r, include = explain}
selected_stocks <- read_csv("./data/top_50.csv") %>% mutate(Symbol = str_trim(Symbol))
stock_names <- selected_stocks$Name
names(stock_names) <- selected_stocks$Symbol
```



```{r, include = explain}

lag_levels <- c("1 Week","1 Month","3 Months","6 Months","1 Year","2 Years","5 Years")
framework <- 
  stocks %>% 
  ungroup() %>%
  mutate(lag = factor(rep("1 Month", nrow(.)), levels = lag_levels))%>%
  expand(ticker,lag) 
```


```{r,include = explain}

max_date <- as.Date("2018-08-24")

xf <- framework %>% 
  left_join(preview, by = "ticker") %>% 
  group_by(lag) %>%
  do(convert_lag(.,max_date)) %>%
  subset(date >= start_date & date <= max_date) %>%
  arrange(ticker,lag,date) %>%
  ungroup() %>%
  group_by(ticker,lag) %>%
  summarise(volume_values = list(list("volume" = volume, "date"= date)),
            close_values = list(list("close" = close, "date"= date))) %>% 
  ungroup()

xf$change <-
  sapply(xf$close_values, function(x){
    round((pluck(x,"close") %>% tail(1) - pluck(x,"close")[1]) / pluck(x,"close")[1],4)
  })

```



```{r}

stock_theme <- reactableTheme(backgroundColor = "black", color = "white")

sdf <- SharedData$new(xf)
div(style = 'font-family: "Work Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;background-color:black;color:white;padding:20px;',
    h2(class = "title", "Stocks - Top 50"),
    filter_select("ticker", "Ticker", sdf, ~ticker),
    filter_checkbox("lags", "Time Period", sdf, ~lag, allLevels = FALSE, inline = TRUE),
    reactable(sdf,
              theme = stock_theme,
              columns = list(
                ticker = colDef(
                  name = "Company",
                  width = 200,
                  cell = function(value){
                    list(p(value,style = "font-weight: bold;"),
                         p(purrr::pluck(stock_names,value),style = "color:#a8a8a8;")
                    )
                  }
                ),
                volume_values = colDef(
                  name = "Volume",
                  sortable = FALSE,
                  cell = function(values) {
                    volume_sparkline(values)
                  }
                ),
                close_values = colDef(
                  name = "Closing Value",
                  sortable = FALSE,
                  cell = function(values) {
                    build_sparkline_2(values)
                  }
                ),
                lag = colDef(show = FALSE),
                change = colDef(name = "Change",
                                align = "center",
                                style = "padding-top:25px",
                                cell = function(value){
                                  stock_delta(value)
                                }
                                )
                )
              )
    )



```

